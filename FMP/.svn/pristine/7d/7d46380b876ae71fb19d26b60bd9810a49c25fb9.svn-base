using Full_Metal_Planete.src.decorators;
using Full_Metal_Planete.src.decorators.factory;
using Full_Metal_Planete.src.tests.box_selection;
using Full_Metal_Planete.src.user_controls;
using FullMetalPlaneteDAL;
using FullMetalPlaneteDAL.ImageLoader;
using Metier;
using Metier.Unites;
using System;
using System.Collections.Generic;
using System.Threading;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;

namespace Full_Metal_Planete.src.game.game_window
{
    /// <summary>
    /// Logique d'interaction pour FullscreenWindow.xaml
    /// </summary>
    public partial class FullscreenWindow : Window
    {
        public const int MAXZINDEX = 11;

        private static string _path = Environment.CurrentDirectory + "\\src";

        private bool _urisLoaded = false;

        private MapHMI _map;

        private Jeu _game = new Jeu();

        private Joueur _player;

        private MainWindow _mainWindow;

        #region graphics items
        private Grid _bottomLeft;
        private Grid _bottomCenter;
        private Grid _bottomRight;

        private UnitListView _unitList;

        private Label _consoleOutput = new Label();

        private Image _currentGhostImage = null;

        private MediaElement media = new MediaElement()
        {
            Source = new Uri(_path + "\\files\\media\\ecran_chargement.mp4"),
            Visibility = Visibility.Visible,
            Stretch = Stretch.Fill,
            Height = 1080,
            LoadedBehavior = MediaState.Manual
        };
        #endregion

        #region names arrays & files
        private static string[] unitsNames =
            {
                "astronef.png",
                "barge.png",
                "barge2.png",
                "big_tank.png",
                "BigTank2.png",
                "boat.png",
                "crab.png",
                "Crab2.png",
                "Crab3.png",
                "ponton.png",
                "question_mark.png",
                "tank.png",
                "Tank2.png",
                "time.png",
                "weather_layer.png",
            };
        private static string[] hexagonsNames =
            {
                "eau.png",
                "eau2.png",
                "maracage.png",
                "montagne.png",
                "plaine.png",
                "recif.png",
                "question_mark.png",
            };

        private FileLoader _unitsFileLoader;
        private FileLoader _hexagonsFileLoader;
        #endregion

        public FullscreenWindow(MainWindow w)
        {
            // WPF
            InitializeComponent();
            _mainWindow = w;
            DataContext = _mainWindow;
            // work
            LoadSettings();
            Thread t = new Thread(new ThreadStart(LoadAssets));
            t.Start();
            LoadingScreen();
        }

        #region second thread & assets
        /*
         * Function using DAL class to create Uris for map sprites
         */
        private void LoadAssets()
        {
            Dictionary<string, Uri> tempPathes = new Dictionary<string, Uri>();
            _unitsFileLoader = new ImageLoader(_path + "\\files\\images\\question_mark.png");
            _unitsFileLoader.Load(unitsNames, _path + "\\files\\images\\sprites\\");
            _hexagonsFileLoader = new ImageLoader(_path + "\\files\\images\\question_mark.png");
            _hexagonsFileLoader.Load(hexagonsNames, _path + "\\files\\images\\sprites\\hexagons\\");
            _map = new MapHMI(_game.Carte);
            _player = new Joueur(_map.Map);
            _urisLoaded = true;
        }

        /*
         * Function running in main thread while assets are being loaded
         */
        private void LoadingScreen()
        {
            Rectangle fillBlank = new Rectangle()
            {
                Stroke = Brushes.Black,
                Fill = Brushes.Black,
                HorizontalAlignment = HorizontalAlignment.Left,
                VerticalAlignment = VerticalAlignment.Center,
                Height = 1080,
                Width = 1920
            };
            media.MediaEnded += new RoutedEventHandler(Media_OnMediaEnded);
            // RECTANGLE
            Canvas.SetTop(fillBlank, 0);
            Canvas.SetLeft(fillBlank, 0);
            Canvas.SetZIndex(fillBlank, 0);
            _mapCanvas.Children.Add(fillBlank);
            // MEDIA
            Canvas.SetTop(media, 0);
            Canvas.SetLeft(media, 250);
            Canvas.SetZIndex(media, 1);
            _mapCanvas.Children.Add(media);
            media.Play();
        }
        #endregion

        private void BuildReserve()
        {
            _unitList.AddUnit(UnitHMIFactory.BuildUnitHMI(TypeEntite.ASTRONEF, null, null, _unitsFileLoader));
            _unitList.AddUnit(UnitHMIFactory.BuildUnitHMI(TypeEntite.ASTRONEF, null, null, _unitsFileLoader));
            _unitList.AddUnit(UnitHMIFactory.BuildUnitHMI(TypeEntite.ASTRONEF, null, null, _unitsFileLoader));
        }

        private void DrawPhantomUnit(DragEventArgs e)
        {
            if (e.Data.GetDataPresent("Object"))
            {
                var v = e.Data.GetData("Object");
                if (v is UnitHMI unit)
                {
                    if (_currentGhostImage == null)
                    {
                        _currentGhostImage = unit.Image;
                        _mapCanvas.Children.Add(_currentGhostImage);
                        Canvas.SetZIndex(_currentGhostImage, FullscreenWindow.MAXZINDEX);
                    }
                    Canvas.SetLeft(_currentGhostImage, e.GetPosition(_mapCanvas).X - (_currentGhostImage.Width / 2));
                    Canvas.SetTop(_currentGhostImage, e.GetPosition(_mapCanvas).Y - (_currentGhostImage.Height / 2));
                }
            }
        }

        #region user interface
        private void DrawUI()
        {
            _scrollPanel.VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;
            Brush aRGBcolor = new SolidColorBrush(Color.FromArgb(50, 50, 100, 150));

            #region grid
            _bottomLeft = new Grid()
            {
                Height = 246,
                Width = 327,
                Background = aRGBcolor,
            };

            _bottomCenter = new Grid()
            {
                Height = 246,
                Width = 1195,
                Background = aRGBcolor,
            };

            _bottomRight = new Grid()
            {
                Height = 246,
                Width = 400,
                Background = aRGBcolor,
            };
            #region units display

            _unitList = new UnitListView();
            _bottomRight.Children.Add(_unitList);

            #endregion

            #endregion

            #region border
            Border background = new Border()
            {
                BorderBrush = Brushes.Black,
                BorderThickness = new Thickness(2)
            };
            Border background2 = new Border()
            {
                BorderBrush = Brushes.Black,
                BorderThickness = new Thickness(2)
            };
            Border background3 = new Border()
            {
                BorderBrush = Brushes.Black,
                BorderThickness = new Thickness(2)
            };
            _bottomLeft.Children.Add(background);
            _bottomCenter.Children.Add(background2);
            _bottomRight.Children.Add(background3);
            #endregion

            #region time zone // can be a user control (later)
            Rectangle timeZoneContainer = new Rectangle()
            {
                Stroke = Brushes.Black,
                Fill = Brushes.DarkOrange,
                HorizontalAlignment = HorizontalAlignment.Left,
                VerticalAlignment = VerticalAlignment.Center,
                Height = 50,
                Width = 100,
            };

            Label timer = new Label()
            {
                Content = "00 : 00",
                Background = Brushes.Transparent,
            };

            Image timePNG = new Image()
            {
                Source = new BitmapImage(_unitsFileLoader.GetUri("time.png")),
                Height = 28,
                Width = 16,
            };

            Canvas timeZone = new Canvas()
            {
                Margin = new Thickness(20),
            };

            Canvas.SetTop(timeZoneContainer, 0);
            Canvas.SetLeft(timeZoneContainer, 0);
            Canvas.SetZIndex(timeZoneContainer, 0);
            Canvas.SetTop(timePNG, 5);
            Canvas.SetLeft(timePNG, 5);
            Canvas.SetZIndex(timePNG, 1);
            Canvas.SetTop(timer, 5);
            Canvas.SetLeft(timer, 20);
            Canvas.SetZIndex(timer, 1);

            timeZone.Children.Add(timeZoneContainer);
            timeZone.Children.Add(timePNG);
            timeZone.Children.Add(timer);

            _bottomLeft.Children.Add(timeZone);
            #endregion 

            #region toolbar
            ToolBarTray toolBarTray = new ToolBarTray()
            {
                Background = Brushes.Transparent,
            };

            Border toolBarBorder = new Border()
            {
                BorderThickness = new Thickness(0),
            };

            ToolBar toolBar = new ToolBar();
            toolBar.Items.Add(toolBarBorder);
            Menu menu = new Menu();

            MenuItem menuItem = new MenuItem()
            {
                Header = "Options",
            };

            MenuItem menuItem1 = new MenuItem()
            {
                Header = "Quit",
            };

            menuItem1.Click += new RoutedEventHandler(BtnClose_Click);
            // build toolbar tray
            menuItem.Items.Add(menuItem1);
            menu.Items.Add(menuItem);
            toolBar.Items.Add(menu);
            toolBarTray.ToolBars.Add(toolBar);
            Canvas.SetZIndex(toolBarTray, 10);
            _mapCanvas.Children.Add(toolBarTray);
            #endregion

            #region label
            Canvas.SetBottom(_consoleOutput, 10);
            Canvas.SetLeft(_consoleOutput, 50);
            Canvas.SetZIndex(_consoleOutput, 10);
            _bottomCenter.Children.Add(_consoleOutput);
            #endregion

            AddElements(_bottomLeft, _bottomCenter, _bottomRight);

            _map.DrawMap(_mapCanvas, _hexagonsFileLoader.Uris);

            BuildReserve();
            new BoxPositionDrawing(_map, _mapCanvas).DrawPoints();
        }

        private void AddElements(Grid bottomLeft, Grid bottomCenter, Grid bottomRight)
        {
            // on the left side
            Canvas.SetLeft(bottomLeft, 0);
            Canvas.SetTop(bottomLeft, 805);
            Canvas.SetZIndex(bottomLeft, 5);
            // in the center
            Canvas.SetLeft(bottomCenter, 326);
            Canvas.SetTop(bottomCenter, 805);
            Canvas.SetZIndex(bottomCenter, 5);
            // on the left side
            Canvas.SetLeft(bottomRight, 1520);
            Canvas.SetTop(bottomRight, 805);
            Canvas.SetZIndex(bottomRight, 5);
            // adding to display
            _uiCanvas.Children.Add(bottomLeft);
            _uiCanvas.Children.Add(bottomCenter);
            _uiCanvas.Children.Add(bottomRight);
        }
        #endregion

        #region events
        protected override void OnMouseMove(MouseEventArgs e)
        {
            base.OnMouseMove(e);
            if (_urisLoaded)
            {
            }

        }

        protected override void OnDrop(DragEventArgs e)
        {
            base.OnDrop(e);
            if (e.Data.GetDataPresent("TypeEntite"))
            {
                BoxHMI box = _map.ChooseBox(e.GetPosition(_mapCanvas));
                if (Astronef.EstPosable(box.Case))
                {
                    UnitHMI unit = UnitHMIFactory.BuildUnitHMI((TypeEntite)e.Data.GetData("TypeEntite"), null, null, _unitsFileLoader);
                    _map.PlaceUnit(unit, _mapCanvas, box);
                    _unitList.RemoveUnit();
                    _game.PoserBase(_player ,box.Case);
                }
            }
            _mapCanvas.Children.Remove(_currentGhostImage);
            _currentGhostImage = null;
            e.Handled = true;
        }

        protected override void OnDragOver(DragEventArgs e)
        {
            base.OnDragOver(e);
            DrawPhantomUnit(e);
            if (Astronef.EstPosable(_map.ChooseBox(e.GetPosition(_mapCanvas)).Case))
            {
                _currentGhostImage.Opacity = 1;
            }
            else
            {
                _currentGhostImage.Opacity = 0.5;
            }
            e.Handled = true;
        }

        private void Media_OnMediaEnded(object sender, RoutedEventArgs e)
        {
            if (sender is MediaElement media)
            {
                if (_urisLoaded)
                {
                    media.Stop();
                    _mapCanvas.Children.Remove(media);

                    Image tempImage = null;
                    Rectangle tempRect = null;
                    foreach (UIElement elt in _mapCanvas.Children)
                    {
                        if (elt is Image image)
                            tempImage = image;
                        if (elt is Rectangle rectangle)
                            tempRect = rectangle;
                    }
                    if (null != tempImage)
                        _mapCanvas.Children.Remove(tempImage);
                    if (null != tempRect)
                        _mapCanvas.Children.Remove(tempRect);
                    DrawUI();
                }
                else
                {
                    media.Position = TimeSpan.FromSeconds(0);
                    media.Play();
                }
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e) => Close();
        #endregion

        #region window settings
        private void LoadSettings()
        {
            if (_mainWindow.FSWindowState == WindowState.Normal)
            {
                Width = _mainWindow.FSResolution.ResX;
                Height = _mainWindow.FSResolution.ResY;
            }
            else
            {
                WindowState = _mainWindow.FSWindowState;
            }
            _scrollPanel.VerticalScrollBarVisibility = ScrollBarVisibility.Disabled;
        }

        public void FakeConsoleOutput(Canvas canvas, string str)
        {
            _consoleOutput.Content = str;
        }
        #endregion
    }
}

using Metier.Carte.Cases;
using Metier.Unites;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Runtime.Serialization;
using System.Runtime.Serialization.Json;
using System.IO;

namespace Metier.Carte
{
    
    public class Map : ICarte

    {
        
        private static Dictionary<Coordonnee,Case> cases;

        public Map()
        {
            cases = new Dictionary<Coordonnee, Case>();
            generationCarte();
            generationVoisins();

        }

        /*
         * Cette fonction génère les cases présentes 
         */
        private void generationCarte()
        {
            #region Carte
            string str = "PPMPPPPEMEPPPPSPPPPPPPPPSSMMEPPSPPPPPXPPPPPPSSMPPPPSSSPPPPPPPPSSSPSPPPSSPPPXPPPSPPPPSSSPPPSSPPPPPSSPEPPSMPPPSPSPPXPPMMSEEPPMSPSESPEPPPPMMEPPPPMPPEEPPMMXMPMSPEEPPEEEEEPMEMMPMPEEEEPEEEEEEEEMPXPPPEEEEEREEEEEMEEPPPPPEREEPEEEEEEREPPXPPPEEPPRREEEEERESPPPPPERPRREEEEEERMPPXPPPSPRPREEEEEEEMSPPPPPPRPSERRREEEPMPPXPSPSERSMERPREEEPSPPPPPPEPMEPPREEEPPSPXPPPSEESPPPMEEEEPPPPPPPEEESEPMPEREEPSPXPPPEEEPEPPPSPEREPSPPPSEEEEEPMPPEREPPSXSPPPEEPEEPPSPEREPMSSPEEEPEEEMSPMEEPPSXSMEPEEPEEMSSMEEEPSSSMEREEPEEPPSPEEPEPXMSEPRREEEPSPMREPEPPMSPPREEMSPPERPEEPPXMPPPRPEERPSERREPPPPPSPPPMEMSPPESEEEPPXPPPPPEEEREEERMSMPPPPSPEREMEEEEESEREPPXPPEEREMREEEEEEPEPPPPMMEPEPREEEEEEPMPPXPPRMRESEPPEEEEPRMPPPMMEEESEPEEEEEEPMPXPMEERESEPPPPEPEPPMPPMERPSSPPPPEEPSPPPXPMSEPPSSPPPPEPPSPPPPSSPPSSPPPPPSPMPPPXPMSSPPSPPPPPPSMSPPPPSSPPPPPPPPPPSEPPPXPPPPPPSPPMPPPPEPPPPPPPPPSEPMMPPPSPPPPXPPPPPPPEMMPPPSSPPPPPPPPPSPMMMMPSPPPPPX";
            #endregion

            #region creationCases
            for (int i = 0; i < 46; i++)
            {
                for(int j = 0; j < 19; j++)
                {
                    char c = str[i + j];
                    switch (c)
                    {
                        case 'P':
                            ajouterCase(FabriqueCases.creeCase(TypeCases.PLAINE, new Coordonnee(i, j)));
                            break;
                        case 'R':
                            ajouterCase(FabriqueCases.creeCase(TypeCases.RECIF, new Coordonnee(i, j)));
                            break;
                        case 'M':
                            ajouterCase(FabriqueCases.creeCase(TypeCases.MONTAGNE, new Coordonnee(i, j)));
                            break;
                        case 'S':
                            ajouterCase(FabriqueCases.creeCase(TypeCases.MARECAGE, new Coordonnee(i, j)));
                            break;
                        case 'E':
                            ajouterCase(FabriqueCases.creeCase(TypeCases.MER, new Coordonnee(i, j)));
                            break;
                        case 'X':
                            break;
                        default:
                            throw new Exception("Type de case inconu lors de la génération");
                    }
                }
            }
            #endregion

        }


        /*
         * Génère les tous les voisins de toutes les cases (comme on les connais déjà toutes)
         */
        private void generationVoisins() //a vérifié que les cases au bord n'est pas de voisins "vide"
        {
            foreach (Case c in cases.Values)
            {
                foreach (TypeDirection type in Enum.GetValues(typeof(TypeDirection)))
                {
                    if(cases.TryGetValue(c.Coordonnee.voisin(type), out Case ca))
                        c.AjouterVoisin(ca,type);
                }
            }
        }

        /*
         * Donne la case de la carte correspondante a la coordonnée donné en paramètre
         */
        public Case GetCase(Coordonnee coordonnee)
        {
            
            Case c = cases[coordonnee];
            return c;
        }

        /*
         * Donne toutes les cases présentes dans la carte
         */
        public ICollection<Case> getCases()
        {
            return cases.Values;
        }

        /*
         * Ajoute une case a la carte
         */
        public void ajouterCase(Case c)
        {
            cases.Add(c.Coordonnee,c);
        }

        /*
         * Ajoute une unité sur la carte
         */
        public void ajouterUnite(Unite u, Case c)
        {
            this.GetCase(c.Coordonnee).Unit = u;
            
        }

      

    }
}

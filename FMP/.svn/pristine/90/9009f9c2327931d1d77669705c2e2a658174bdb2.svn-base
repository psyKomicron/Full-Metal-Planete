using Full_Metal_Planete.src.game.game_window;
using Metier.Carte;
using Metier.Carte.Cases;
using Metier.Unites;
using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media.Imaging;

namespace Full_Metal_Planete.src.decorators
{
    public class MapIHM : ICarte
    {
        private Map map;

        private List<BoxIHM> boxIHMs;

        public List<BoxIHM> BoxesIHM { get => boxIHMs; }

        public MapIHM(Map carte)
        {
            this.map = carte;
            boxIHMs = new List<BoxIHM>();
        }

        public BoxIHM ChooseBox(Point cursorPosition)
        {
            double delta = 2000;
            BoxIHM tempBoxIHM = null;
            foreach (BoxIHM box in boxIHMs)
            {
                double dist = Math.Sqrt(
                    Math.Pow((box.Position.X - cursorPosition.X), 2)
                    +
                    Math.Pow((box.Position.Y - cursorPosition.Y), 2)
                    );
                if (delta > dist)
                {
                    delta = dist;
                    tempBoxIHM = box;
                }
            }
            /*
            */
            return tempBoxIHM;
        }

        public void PlaceUnit(UnitIHM unit, Canvas canvas, BoxIHM boxIHM)
        {
            Image image = unit.Image;
            Canvas.SetLeft(image, (boxIHM.GetCenter().X - image.Width / 2) - 50);
            Canvas.SetTop(image, (boxIHM.GetCenter().Y - image.Height / 2) + 30);
            Canvas.SetZIndex(image, FullscreenWindow._MAXZINDEX);
            canvas.Children.Add(image);
        }

        #region drawing map
        public void DrawMap(Canvas canvas, IDictionary<string, Uri> imagesPathes)
        {
            BuildBoxes(imagesPathes);
            double[] coordinate;

            foreach (BoxIHM box in boxIHMs)
            {
                coordinate = GiveCoordinate(box);
                Canvas.SetTop(box.Sprite, coordinate[0]);
                Canvas.SetLeft(box.Sprite, coordinate[1]);
                Canvas.SetZIndex(box.Sprite, 1);
                canvas.Children.Add(box.Sprite);
                box.Position = new System.Windows.Point(coordinate[1], coordinate[0]);
            }
        }

        private double[] GiveCoordinate(BoxIHM box)
        {
            double[] coordinate = new double[2];
            coordinate[0] = 0;
            coordinate[1] = 0;
            int coorY = box.Coordonnee.Y;
            int coorX = box.Coordonnee.X;
            // Correcting .png problems
            int yOffset = 15;// 13
            int xOffset = 8; // 8


            if (coorX % 2 == 0)
            {
                coordinate[1] = (coorY * (box.Sprite.Width + (box.Sprite.Width / 2)));
                coordinate[0] = (coorX / 2) * (box.Sprite.Height - xOffset);
            }
            else
            {
                if (coorY == 0)
                {
                    coordinate[1] = (box.Sprite.Width / 2) + yOffset;
                }
                else
                {
                    coordinate[1] = ((box.Sprite.Width / 2) + yOffset) + ((box.Sprite.Width + (box.Sprite.Width / 2)) * coorY);
                }
                coordinate[0] = ((box.Sprite.Height - xOffset) / 2) * coorX;
            }
            return coordinate;
        }

        private void BuildBoxes(IDictionary<string, Uri> pathes)
        {
            foreach (Case box in map.GetCases())
            {
                Image img = new Image()
                {
                    Height = 68,
                    Width = 68,
                };
                switch (box.Type())
                {
                    case TypeCases.MARECAGE:
                        img.Source = new BitmapImage(pathes["maracage.png"]);
                        break;
                    case TypeCases.MER:
                        img.Source = new BitmapImage(pathes["eau2.png"]);
                        break;
                    case TypeCases.MONTAGNE:
                        img.Source = new BitmapImage(pathes["montagne.png"]);
                        break;
                    case TypeCases.PLAINE:
                        img.Source = new BitmapImage(pathes["plaine.png"]);
                        break;
                    case TypeCases.RECIF:
                        img.Source = new BitmapImage(pathes["recif.png"]);
                        break;
                    default:
                        img.Source = new BitmapImage(pathes["question_mark.png"]);
                        break;
                }
                boxIHMs.Add(new BoxIHM(box)
                {
                    Sprite = img,
                });
            }
        }
        #endregion

        #region interface implementation
        public Case GetCase(Coordonnee coordonnee)
        {
            return map.GetCase(coordonnee);
        }

        public ICollection<Case> GetCases()
        {
            return map.GetCases();
        }

        public void AjouterCase(Case c)
        {
            map.AjouterCase(c);
        }
        #endregion
    }
}

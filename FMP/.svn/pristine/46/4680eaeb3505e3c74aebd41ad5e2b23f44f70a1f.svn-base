using Full_Metal_Planete.src.game.game_window;
using Metier.Carte;
using Metier.Carte.Cases;
using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media.Imaging;

namespace Full_Metal_Planete.src.decorators
{
    public class MapHMI : ICarte
    {
        private Map map;

        private List<BoxHMI> boxIHMs;

        private const double _imageHeight = 69;
        private const double _imageWidth = 69;

        public List<BoxHMI> BoxesIHM { get => boxIHMs; }

        public Map Map => map;

        public MapHMI(Map carte)
        {
            this.map = carte;
            boxIHMs = new List<BoxHMI>();
        }

        public BoxHMI ChooseBox(Point cursorPosition)
        {
            double delta = 2000;
            BoxHMI tempBoxIHM = null;
            foreach (BoxHMI box in boxIHMs)
            {
                double dist = Math.Sqrt(
                    Math.Pow((box.GetCenter().X - cursorPosition.X), 2)
                    +
                    Math.Pow((box.GetCenter().Y - cursorPosition.Y), 2)
                    );
                if (delta > dist)
                {
                    delta = dist;
                    tempBoxIHM = box;
                }
            }
            return tempBoxIHM;
        }

        public void PlaceUnit(UnitHMI unit, Canvas canvas, BoxHMI boxIHM)
        {
            Image image = unit.Image;
            Canvas.SetLeft(image, (boxIHM.GetCenter().X - unit.GetCenter().X));
            Canvas.SetTop(image, (boxIHM.GetCenter().Y - unit.GetCenter().Y ));
            Canvas.SetZIndex(image, FullscreenWindow.MAXZINDEX);
            canvas.Children.Add(image);
            unit.Position = new Point(Canvas.GetLeft(unit.Image), Canvas.GetTop(unit.Image));
        }

        #region drawing map
        public void DrawMap(Canvas canvas, IDictionary<string, Uri> imagesPathes)
        {
            BuildBoxes(imagesPathes);
            double[] coordinate;

            foreach (BoxHMI box in boxIHMs)
            {
                coordinate = GiveCoordinate(box);
                Canvas.SetTop(box.Sprite, coordinate[0]);
                Canvas.SetLeft(box.Sprite, coordinate[1]);
                Canvas.SetZIndex(box.Sprite, 1);
                canvas.Children.Add(box.Sprite);
                box.Position = new System.Windows.Point(coordinate[1], coordinate[0]);
            }
            foreach (BoxHMI box in boxIHMs)
                if (box.Case.Minerai)
                    box.BoxSelected();
        }

        private double[] GiveCoordinate(BoxHMI box)
        {
            double[] coordinate = new double[2];
            coordinate[0] = 0;
            coordinate[1] = 0;
            int coorY = box.Coordonnee.Y;
            int coorX = box.Coordonnee.X;
            // Correcting .png problems
            int yOffset = 15;
            int xOffset = 8;
            if (coorX % 2 == 0)
            {
                coordinate[1] = (coorY * (box.Sprite.Width + (box.Sprite.Width / 2)));
                coordinate[0] = (coorX / 2) * (box.Sprite.Height - xOffset);
            }
            else
            {
                if (coorY == 0)
                    coordinate[1] = (box.Sprite.Width / 2) + yOffset;
                else
                    coordinate[1] = ((box.Sprite.Width / 2) + yOffset) + ((box.Sprite.Width + (box.Sprite.Width / 2)) * coorY);
                coordinate[0] = ((box.Sprite.Height - xOffset) / 2) * coorX;
            }
            coordinate[0] -= 5;
            coordinate[1] -= 5;
            return coordinate;
        }

        private void BuildBoxes(IDictionary<string, Uri> pathes)
        {
            foreach (Case box in map.GetCases())
            {
                Image img = new Image()
                {
                    Height = _imageHeight,
                    Width = _imageWidth,
                };
                switch (box.Type())
                {
                    case TypeCases.MARECAGE:
                        img.Source = new BitmapImage(pathes["maracage.png"]);
                        break;
                    case TypeCases.MER:
                        img.Source = new BitmapImage(pathes["eau2.png"]);
                        break;
                    case TypeCases.MONTAGNE:
                        img.Source = new BitmapImage(pathes["montagne.png"]);
                        break;
                    case TypeCases.PLAINE:
                        img.Source = new BitmapImage(pathes["plaine.png"]);
                        break;
                    case TypeCases.RECIF:
                        img.Source = new BitmapImage(pathes["recif.png"]);
                        break;
                    default:
                        img.Source = new BitmapImage(pathes["question_mark.png"]);
                        break;
                }
                boxIHMs.Add(new BoxHMI(box)
                {
                    Sprite = img,
                });
            }
        }
        #endregion

        #region interface implementation
        public Case GetCase(Coordonnee coordonnee)
        {
            return map.GetCase(coordonnee);
        }

        public ICollection<Case> GetCases()
        {
            return map.GetCases();
        }

        public void AjouterCase(Case c)
        {
            map.AjouterCase(c);
        }
        #endregion
    }
}
